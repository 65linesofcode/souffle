#!/bin/sh
#
# Copyright (c) 2013-14, Oracle and/or its affiliates. All rights reserved.
#
# The Universal Permissive License (UPL), Version 1.0
#
# Subject to the condition set forth below, permission is hereby granted to any person obtaining a copy of this software,
# associated documentation and/or data (collectively the "Software"), free of charge and under any and all copyright rights in the 
# Software, and any and all patent rights owned or freely licensable by each licensor hereunder covering either (i) the unmodified 
# Software as contributed to or provided by such licensor, or (ii) the Larger Works (as defined below), to deal in both
# 
# (a) the Software, and
# (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if one is included with the Software (each a "Larger
# Work" to which the Software is contributed by such licensors),
#
# without restriction, including without limitation the rights to copy, create derivative works of, display, perform, and 
# distribute the Software and make, use, sell, offer for sale, import, export, have made, and have sold the Software and the 
# Larger Work(s), and to sublicense the foregoing rights on either these or other terms.
#
# This license is subject to the following condition:
# The above copyright notice and either this complete permission notice or at a minimum a reference to the UPL must be included in 
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
# OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
# IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

#
# script that compiles a generated C++ program and executes it
#

# Show usage
usage() {
  printf "Name:
  souffle-compile - compile a C++ source file generated by souffle
Usage:
  souffle-compile [options] <FILE>.cpp
Options:
  -h           show usage
  -s           compile a program with OpenMP support
  -v           verbose output
  -w           enable warnings\n"
  exit 1;
}

# Print a message to STDERR and exit. If the second argument (exit code)
# is provided and it is '0' then do nothing, otherwise print the error message
# along with the usage (if the third argument is defined)
error() {
  if [ -z "$2" ] || ! [ "$2" = 0 ]; then
    echo "souffle-compile error: $1" 1>&2
    if [ -n "$3" ]; then
      usage;
    fi
    exit 1;
  fi
}

## set environment variables

# set by autoconf
CXX=@CXX@
CXXFLAGS="@CXXFLAGS@"
LDFLAGS="@LDFLAGS@"
LIBS="@LIBS@"
OMP_FLAG="@OPENMP_CFLAGS@"

# set by command flags
WARNINGS=""

# find header files of souffle
TEST_HEADER="souffle/CompiledRamRelation.h"
HEADER_DIR=$(dirname $0)/../include
test -f "$HEADER_DIR/$TEST_HEADER"
error "installation error: souffle header files cannot be found" $?

# Options processing via getopts builtin, it is very limiting but on OSX the
# default getopt is an old BSD getopt, so need this for portability
while getopts "hwvs" opt; do
  case "$opt" in
    h|\?) # Show usage and exit
      usage;
    ;;
    w) # enable warnings
      WARNINGS="1"
    ;;
    v) # Verbose output
      set -x
    ;;
    s) # compile without openmp
      OMP_FLAG=""
    ;;
  esac
done

# Shift positional arguments
shift $(($OPTIND - 1))

# Show usage if no input is given
test -n "$1"
error "no input file" $? 1

# Check if the input file exists
test -f "$1"
error "cannot open source file: '$1'" $?

# Compile
exe=`basename $1 .cpp`
rm -f ./$exe
$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG 2> ./$exe.$$.ccerr
if test -f ./$exe
then
  if [ "$WARNINGS" = 1 ]
  then
     echo "$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG"
     cat ./$exe.$$.ccerr 1>&2
  fi
  rm ./$exe.$$.ccerr
else
  echo "compiler error: cannot compile source file $1" 1>&2
  echo "$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG"
  cat ./$exe.$$.ccerr 1>&2
  rm -f ./$exe.$$.ccerr
  exit 1
fi
exit 0
